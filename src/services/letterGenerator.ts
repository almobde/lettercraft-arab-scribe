
import { LetterData, GeneratedLetter } from '../types/letter';

const getHijriDate = () => {
  const today = new Date();
  // تحويل تقريبي للتاريخ الهجري
  const hijriYear = Math.floor((today.getFullYear() - 622) * 1.030684) + 1;
  const hijriMonths = [
    'مُحَرَّم', 'صَفَر', 'رَبِيع الأَوَّل', 'رَبِيع الثَّانِي', 'جُمَادَى الأُولَى', 'جُمَادَى الثَّانِيَة',
    'رَجَب', 'شَعْبَان', 'رَمَضَان', 'شَوَّال', 'ذُو القَعْدَة', 'ذُو الحِجَّة'
  ];
  const hijriMonth = hijriMonths[today.getMonth()];
  const hijriDay = today.getDate();
  
  return `${hijriDay} ${hijriMonth} ${hijriYear}هـ`;
};

const getGregorianDate = () => {
  const today = new Date();
  const months = [
    'يَنَايِر', 'فِبْرَايِر', 'مَارِس', 'أَبْرِيل', 'مَايُو', 'يُونْيُو',
    'يُولْيُو', 'أَغُسْطُس', 'سِبْتَمْبَر', 'أُكْتُوبَر', 'نُوفَمْبَر', 'دِيسَمْبَر'
  ];
  
  return `${today.getDate()} ${months[today.getMonth()]} ${today.getFullYear()}م`;
};

const truncateToCharLimit = (text: string, limit: number): string => {
  if (text.length <= limit) return text;
  
  // البحث عن آخر جملة مكتملة قبل الحد الأقصى
  const sentences = text.split('.');
  let result = '';
  
  for (const sentence of sentences) {
    const potentialResult = result + sentence + '.';
    if (potentialResult.length <= limit) {
      result = potentialResult;
    } else {
      break;
    }
  }
  
  // إذا لم نحصل على أي جملة كاملة، نقص النص عند آخر مسافة
  if (result === '') {
    const lastSpace = text.lastIndexOf(' ', limit);
    result = text.substring(0, lastSpace > 0 ? lastSpace : limit);
  }
  
  return result.trim();
};

const generateLocalLetter = (letterData: LetterData): GeneratedLetter => {
  const hijriDate = getHijriDate();
  const gregorianDate = getGregorianDate();
  
  let mainContent = '';
  const lowerOccasion = letterData.occasion.toLowerCase();
  
  // تحديد حدود الأحرف حسب طول الخطاب
  const charLimits = {
    'قصير': 299,    // أقل من 300
    'متوسط': 450,   // بين 300-450
    'طويل': 1000    // أكثر من 550 (نضع حد أعلى معقول)
  };
  
  const targetLimit = charLimits[letterData.letterLength];
  
  // خطابات التهنئة - بلا شكر، فقط تبريك ودعاء
  if (lowerOccasion.includes('زفاف') || lowerOccasion.includes('زواج')) {
    if (letterData.letterLength === 'قصير') {
      mainContent = `نُبَارِكُ لَكُمَا هَذَا الزَّفَافَ المُبَارَكَ، وَنَدْعُو اللهَ أَنْ يَجْمَعَ بَيْنَكُمَا فِي خَيْرٍ وَعَلَى خَيْرٍ، وَأَنْ يَرْزُقَكُمَا السَّعَادَةَ وَالذُّرِّيَّةَ الصَّالِحَةَ.`;
    } else if (letterData.letterLength === 'متوسط') {
      mainContent = `نُبَارِكُ لَكُمَا هَذَا الزَّفَافَ المَيْمُونَ، وَنَدْعُو اللهَ العَظِيمَ أَنْ يَجْمَعَ بَيْنَكُمَا فِي خَيْرٍ وَعَلَى خَيْرٍ، وَأَنْ يُبَارِكَ لَكُمَا وَيُبَارِكَ عَلَيْكُمَا، وَأَنْ يَرْزُقَكُمَا الحُبَّ وَالوِئَامَ وَالذُّرِّيَّةَ الصَّالِحَةَ، وَأَنْ يُدِيمَ عَلَيْكُمَا نِعْمَةَ الإِيمَانِ وَالسَّكِينَةَ.`;
    } else {
      mainContent = `نُبَارِكُ لَكُمَا هَذَا الزَّفَافَ المُبَارَكَ الَّذِي جَمَعَ قَلْبَيْنِ مُؤْمِنَيْنِ فِي رِبَاطٍ مُقَدَّسٍ. نَدْعُو اللهَ العَلِيَّ القَدِيرَ أَنْ يَجْمَعَ بَيْنَكُمَا فِي خَيْرٍ وَعَلَى خَيْرٍ، وَأَنْ يُبَارِكَ لَكُمَا وَيُبَارِكَ عَلَيْكُمَا، وَأَنْ يَرْزُقَكُمَا حَيَاةً زَوْجِيَّةً سَعِيدَةً مَلِيئَةً بِالحُبِّ وَالوِئَامِ وَالسَّكِينَةِ. نَسْأَلُهُ سُبْحَانَهُ أَنْ يُكْرِمَكُمَا بِالذُّرِّيَّةِ الصَّالِحَةِ الَّتِي تَكُونُ قُرَّةَ أَعْيُنِكُمَا، وَأَنْ يَجْعَلَ بَيْتَكُمَا عَامِرًا بِالإِيمَانِ وَالطَّاعَةِ وَالبَرَكَةِ، وَأَنْ يُدِيمَ عَلَيْكُمَا نِعْمَةَ الحُبِّ وَالتَّفَاهُمِ إِلَى يَوْمِ الدِّينِ.`;
    }
  } else if (lowerOccasion.includes('مولود') || lowerOccasion.includes('ولادة')) {
    if (letterData.letterLength === 'قصير') {
      mainContent = `نُبَارِكُ لَكُم قُدُومَ المَوْلُودِ الجَدِيدِ، وَنَدْعُو اللهَ أَنْ يُبَارِكَ لَكُم فِيهِ وَيَجْعَلَهُ قُرَّةَ عَيْنٍ وَيُنْبِتَهُ نَبَاتًا حَسَنًا فِي طَاعَةِ اللهِ.`;
    } else if (letterData.letterLength === 'متوسط') {
      mainContent = `نُبَارِكُ لَكُم قُدُومَ المَوْلُودِ المُبَارَكِ، هَذِهِ الهِبَةُ الرَّبَّانِيَّةُ الَّتِي أَكْرَمَكُمُ اللهُ بِهَا. نَدْعُو اللهَ العَظِيمَ أَنْ يُبَارِكَ لَكُم فِيهِ وَيَجْعَلَهُ قُرَّةَ عَيْنٍ لَكُم، وَأَنْ يُنْبِتَهُ نَبَاتًا حَسَنًا فِي طَاعَةِ اللهِ وَرِضَاهُ، وَأَنْ يَرْزُقَهُ الصِّحَّةَ وَالعَافِيَةَ وَالهِدَايَةَ.`;
    } else {
      mainContent = `نُبَارِكُ لَكُم قُدُومَ المَوْلُودِ المُبَارَكِ الَّذِي أَضَافَ إِلَى بَيْتِكُمُ السُّرُورَ وَالبَهْجَةَ، هَذِهِ النِّعْمَةُ العَظِيمَةُ وَالهِبَةُ الرَّبَّانِيَّةُ الَّتِي أَكْرَمَكُمُ اللهُ بِهَا. نَدْعُو اللهَ العَلِيَّ القَدِيرَ أَنْ يُبَارِكَ لَكُم فِي هَذَا المَوْلُودِ وَيَجْعَلَهُ قُرَّةَ عَيْنٍ لَكُم وَسَنَدًا فِي الدُّنْيَا وَالآخِرَةِ، وَأَنْ يُنْبِتَهُ نَبَاتًا حَسَنًا فِي طَاعَةِ اللهِ وَرِضَاهُ. نَسْأَلُهُ سُبْحَانَهُ أَنْ يَرْزُقَهُ الصِّحَّةَ وَالعَافِيَةَ وَالهِدَايَةَ وَالتَّوْفِيقَ، وَأَنْ يَجْعَلَهُ مِنَ الصَّالِحِينَ المُصْلِحِينَ البَارِّينَ بِوَالِدَيْهِمْ، وَأَنْ يُبَلِّغَهُ أَشُدَّهُ وَهُوَ فِي أَحْسَنِ حَالٍ وَأَكْمَلِ عَقْلٍ وَدِينٍ.`;
    }
  } else if (lowerOccasion.includes('ترقية') || lowerOccasion.includes('منصب')) {
    if (letterData.letterLength === 'قصير') {
      mainContent = `نُبَارِكُ لَكُم تَرْقِيَتَكُم المُسْتَحَقَّةَ، وَنَدْعُو اللهَ أَنْ يُوَفِّقَكُم فِي مَهَامِّكُمُ الجَدِيدَةِ وَيُسَدِّدَ خُطَاكُم فِي خِدْمَةِ الوَطَنِ وَالمُوَاطِنِينَ.`;
    } else if (letterData.letterLength === 'متوسط') {
      mainContent = `نُبَارِكُ لَكُم تَرْقِيَتَكُم المُسْتَحَقَّةَ لِلْمَنْصِبِ الجَدِيدِ، هَذَا الإِنْجَازُ الَّذِي يَعْكِسُ كَفَاءَتَكُم وَجَدَارَتَكُم. نَدْعُو اللهَ العَظِيمَ أَنْ يُوَفِّقَكُم فِي مَسْؤُولِيَّاتِكُمُ الجَدِيدَةِ وَيُسَدِّدَ خُطَاكُم، وَأَنْ يُبَارِكَ فِي جُهُودِكُم فِي خِدْمَةِ الوَطَنِ وَالمُوَاطِنِينَ.`;
    } else {
      mainContent = `نُبَارِكُ لَكُم تَرْقِيَتَكُم المُسْتَحَقَّةَ لِلْمَنْصِبِ الجَدِيدِ، هَذَا الإِنْجَازُ العَظِيمُ الَّذِي يَعْكِسُ كَفَاءَتَكُمُ العَالِيَةَ وَخِبْرَتَكُمُ المُتَمَيِّزَةَ وَجَدَارَتَكُم فِي تَحَمُّلِ المَسْؤُولِيَّاتِ الكَبِيرَةِ. إِنَّ هَذِهِ التَّرْقِيَةَ ثَمَرَةٌ لِسَنَوَاتٍ مِنَ العَمَلِ الجَادِّ وَالعَطَاءِ المُتَمَيِّزِ وَالإِخْلَاصِ فِي الأَدَاءِ. نَدْعُو اللهَ العَلِيَّ القَدِيرَ أَنْ يُوَفِّقَكُم فِي مَهَامِّكُمُ الجَدِيدَةِ وَيُسَدِّدَ خُطَاكُم وَيُبَارِكَ فِي جُهُودِكُم، وَأَنْ يَجْعَلَ عَمَلَكُم فِي خِدْمَةِ الوَطَنِ الغَالِي وَالمُوَاطِنِينَ الكِرَامِ مَبْرُورًا مَقْبُولًا، وَأَنْ يَجْعَلَهُ فِي مِيزَانِ حَسَنَاتِكُم يَوْمَ القِيَامَةِ.`;
    }
  } else if (lowerOccasion.includes('تخرج') || lowerOccasion.includes('شهادة')) {
    if (letterData.letterLength === 'قصير') {
      mainContent = `نُبَارِكُ لَكُم تَخَرُّجَكُمُ المُوَفَّقَ، وَنَدْعُو اللهَ أَنْ يُوَفِّقَكُم فِي مَسِيرَتِكُمُ المِهْنِيَّةِ وَيَفْتَحَ لَكُم أَبْوَابَ النَّجَاحِ وَالتَّمَيُّزِ.`;
    } else if (letterData.letterLength === 'متوسط') {
      mainContent = `نُبَارِكُ لَكُم تَخَرُّجَكُمُ المُوَفَّقَ وَنَيْلَكُمُ الشَّهَادَةَ الجَامِعِيَّةَ، هَذَا الإِنْجَازُ الأَكَادِيمِيُّ الَّذِي يَعْكِسُ جِدَّكُم وَاجْتِهَادَكُم. نَدْعُو اللهَ العَظِيمَ أَنْ يُوَفِّقَكُم فِي مَسِيرَتِكُمُ المِهْنِيَّةِ القَادِمَةِ وَيَفْتَحَ لَكُم أَبْوَابَ النَّجَاحِ وَالتَّمَيُّزِ، وَأَنْ يَجْعَلَكُم نَافِعِينَ لِأَنْفُسِكُم وَمُجْتَمَعِكُم.`;
    } else {
      mainContent = `نُبَارِكُ لَكُم تَخَرُّجَكُمُ المُوَفَّقَ وَنَيْلَكُمُ الشَّهَادَةَ الجَامِعِيَّةَ بِتَفَوُّقٍ وَاسْتِحْقَاقٍ، هَذَا الإِنْجَازُ الأَكَادِيمِيُّ العَظِيمُ الَّذِي يُمَثِّلُ ثَمَرَةَ سَنَوَاتٍ مِنَ الجِدِّ وَالاجْتِهَادِ وَالمُثَابَرَةِ وَالعَزِيمَةِ. نَدْعُو اللهَ العَلِيَّ القَدِيرَ أَنْ يُوَفِّقَكُم فِي مَسِيرَتِكُمُ المِهْنِيَّةِ القَادِمَةِ وَيَفْتَحَ لَكُم أَبْوَابَ النَّجَاحِ وَالتَّمَيُّزِ فِي جَمِيعِ مَيَادِينِ الحَيَاةِ، وَأَنْ يَجْعَلَكُم مِنَ النَّافِعِينَ لِأَنْفُسِكُم وَمُجْتَمَعِكُم وَوَطَنِكُم، وَأَنْ يُبَارِكَ فِي عِلْمِكُم وَعَمَلِكُم وَيَجْعَلَهُ خَالِصًا لِوَجْهِهِ الكَرِيمِ.`;
    }
  } 
  // الأخبار السيئة - نبرة حازمة ومتعاطفة
  else if (lowerOccasion.includes('إقالة') || lowerOccasion.includes('طرد') || lowerOccasion.includes('فصل') || lowerOccasion.includes('استقالة')) {
    if (letterData.letterLength === 'قصير') {
      mainContent = `تَلَقَّيْنَا نَبَأَ ${letterData.occasion} بِكَثِيرٍ مِنَ الأَسَى. نُؤْمِنُ بِقُدْرَتِكُم عَلَى تَجَاوُزِ هَذِهِ المِحْنَةِ وَالانْطِلَاقِ نَحْوَ فُرَصٍ أَفْضَلَ تَلِيقُ بِكَفَاءَتِكُم.`;
    } else if (letterData.letterLength === 'متوسط') {
      mainContent = `تَلَقَّيْنَا نَبَأَ ${letterData.occasion} بِكَثِيرٍ مِنَ الأَسَى وَالتَّأَثُّرِ، وَنُدْرِكُ صُعُوبَةَ هَذِهِ المَرْحَلَةِ عَلَيْكُم. إِنَّ مِثْلَ هَذِهِ التَّجَارِبِ القَاسِيَةِ كَثِيرًا مَا تَكُونُ بِدَايَةً لِانْطِلَاقَةٍ أَقْوَى. نُؤْمِنُ بِقُدْرَتِكُم عَلَى تَجَاوُزِ هَذِهِ المِحْنَةِ وَالانْطِلَاقِ نَحْوَ آفَاقٍ مِهْنِيَّةٍ أَرْحَبَ تُقَدِّرُ كَفَاءَتَكُم وَخِبْرَتَكُم.`;
    } else {
      mainContent = `تَلَقَّيْنَا نَبَأَ ${letterData.occasion} بِكَثِيرٍ مِنَ الأَسَى وَالتَّأَثُّرِ العَمِيقِ، وَنُدْرِكُ تَمَامًا مَا تُمَثِّلُهُ هَذِهِ المَرْحَلَةُ الصَّعْبَةُ مِنْ تَحَدٍّ كَبِيرٍ فِي حَيَاتِكُم المِهْنِيَّةِ وَالشَّخْصِيَّةِ. إِنَّ مِثْلَ هَذِهِ التَّجَارِبِ القَاسِيَةِ وَإِنْ كَانَتْ مُؤْلِمَةً فِي بَادِئِ الأَمْرِ، إِلَّا أَنَّهَا كَثِيرًا مَا تَكُونُ بِدَايَةً لِانْطِلَاقَةٍ جَدِيدَةٍ أَقْوَى وَأَكْثَرَ تَمَيُّزًا. نَحْنُ نَعْرِفُ كَفَاءَتَكُم العَالِيَةَ وَخِبْرَتَكُمُ المُتَمَيِّزَةَ وَمَهَارَاتِكُمُ المِهْنِيَّةَ الرَّاسِخَةَ، وَلِذَلِكَ نُؤْمِنُ إِيمَانًا تَامًّا بِقُدْرَتِكُم عَلَى تَجَاوُزِ هَذِهِ المِحْنَةِ بِقُوَّةٍ وَعَزِيمَةٍ، وَالانْطِلَاقِ نَحْوَ آفَاقٍ مِهْنِيَّةٍ أَرْحَبَ تُقَدِّرُ قَدْرَكُم الحَقِيقِيَّ وَتَسْتَفِيدُ مِنْ خِبْرَاتِكُم القَيِّمَةِ. نَدْعُو اللهَ أَنْ يُيَسِّرَ أُمُورَكُم وَيَفْتَحَ لَكُم أَبْوَابَ الرِّزْقِ الحَلَالِ الطَّيِّبِ.`;
    }
  } else {
    // خطاب عام
    if (letterData.letterLength === 'قصير') {
      mainContent = `نَتَوَجَّهُ إِلَيْكُم بِهَذَا الخِطَابِ بِمُنَاسَبَةِ ${letterData.occasion}، مُعَبِّرِينَ عَنْ تَقْدِيرِنَا وَاحْتِرَامِنَا. نَدْعُو اللهَ أَنْ يُوَفِّقَكُم فِي جَمِيعِ أُمُورِكُم.`;
    } else if (letterData.letterLength === 'متوسط') {
      mainContent = `نَتَوَجَّهُ إِلَيْكُم بِهَذَا الخِطَابِ بِمُنَاسَبَةِ ${letterData.occasion}، مُعَبِّرِينَ عَنْ تَقْدِيرِنَا العَمِيقِ وَاحْتِرَامِنَا الكَبِيرِ لِشَخْصِكُمُ الكَرِيمِ. نَدْعُو اللهَ العَظِيمَ أَنْ يُوَفِّقَكُم فِي جَمِيعِ أَعْمَالِكُم وَمَسَاعِيكُمُ النَّبِيلَةِ وَأَنْ يُسَدِّدَ خُطَاكُم.`;
    } else {
      mainContent = `نَتَوَجَّهُ إِلَيْكُم بِهَذَا الخِطَابِ بِمُنَاسَبَةِ ${letterData.occasion}، مُعَبِّرِينَ عَنْ تَقْدِيرِنَا العَمِيقِ وَاحْتِرَامِنَا الجَمِّ لِشَخْصِكُمُ الكَرِيمِ وَلِمَا تَبْذُلُونَهُ مِنْ جُهُودٍ مُبَارَكَةٍ. إِنَّ مِثْلَ هَذِهِ المُنَاسَبَاتِ تُذَكِّرُنَا بِأَهَمِّيَّةِ التَّوَاصُلِ وَالتَّقْدِيرِ المُتَبَادَلِ بَيْنَ أَفْرَادِ المُجْتَمَعِ الوَاحِدِ. نَدْعُو اللهَ العَلِيَّ القَدِيرَ أَنْ يُوَفِّقَكُم فِي جَمِيعِ أَعْمَالِكُم وَمَسَاعِيكُمُ النَّبِيلَةِ وَأَنْ يُسَدِّدَ خُطَاكُم وَيُبَارِكَ فِي جُهُودِكُمُ المُثْمِرَةِ، وَأَنْ يَجْعَلَ أَعْمَالَكُم فِي مِيزَانِ حَسَنَاتِكُم.`;
    }
  }

  // ضمان الالتزام بحدود الأحرف
  mainContent = truncateToCharLimit(mainContent, targetLimit);

  const arabicLetter = `بِسْمِ اللهِ الرَّحْمَنِ الرَّحِيمِ

${hijriDate}
${gregorianDate}

إِلَى ${letterData.recipientName} الكَرِيم / الكَرِيمَة
${letterData.recipientTitle}

السَّلَامُ عَلَيْكُم وَرَحْمَةُ اللهِ وَبَرَكَاتُهُ

${mainContent}

وَاللهُ المُوَفِّقُ وَالمُسْتَعَانُ

${letterData.senderName}
${letterData.senderOrganization}`;

  const result: GeneratedLetter = {
    arabicVersion: arabicLetter
  };

  // إضافة الترجمة الإنجليزية إذا كانت مطلوبة
  if (letterData.needsTranslation) {
    const englishContent = mainContent
      .replace(/نُبَارِكُ/g, 'We congratulate')
      .replace(/نَدْعُو اللهَ/g, 'We pray to Allah')
      .replace(/تَلَقَّيْنَا نَبَأَ/g, 'We received the news of')
      .replace(/نُؤْمِنُ بِقُدْرَتِكُم/g, 'We believe in your ability');

    result.englishVersion = `In the Name of Allah, the Most Gracious, the Most Merciful

${gregorianDate}

To the Honorable ${letterData.recipientName}
${letterData.recipientTitle}

Peace be upon you and Allah's mercy and blessings

${englishContent}

May Allah grant success and guidance

${letterData.senderName}
${letterData.senderOrganization}`;
  }

  // إضافة النسخة الإبداعية إذا كانت مطلوبة
  if (letterData.needsCreativeVersion) {
    const creativeContent = mainContent
      .replace(/نُبَارِكُ/g, 'نَتَشَرَّفُ بِتَقْدِيمِ أَحَرِّ التَّبْرِيكَاتِ')
      .replace(/نَدْعُو اللهَ/g, 'نَبْتَهِلُ إِلَى اللهِ')
      .replace(/تَلَقَّيْنَا/g, 'وَصَلَنَا');
    
    result.creativeVersion = `بِسْمِ اللهِ الرَّحْمَنِ الرَّحِيمِ

${hijriDate}
${gregorianDate}

إِلَى نَجْمِ المُجْتَمَعِ وَقُدْوَتِهِ ${letterData.recipientName}
${letterData.recipientTitle} المُحْتَرَم

تَحِيَّاتُنَا العَطِرَةُ وَأَطْيَبُ تَمَنِّيَاتِنَا

${truncateToCharLimit(creativeContent, targetLimit)}

دُمْتُم فِي رِعَايَةِ اللهِ وَحِفْظِهِ

${letterData.senderName}
${letterData.senderOrganization}`;
  }

  return result;
};

export const generateLetter = async (letterData: LetterData): Promise<GeneratedLetter> => {
  return generateLocalLetter(letterData);
};
